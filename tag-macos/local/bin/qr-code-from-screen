#!/usr/bin/env bash

# Prints to stdout the first QR code visible on the screen.
#
# Depends on:
# - `screencapture` macos utility [1].
# - `zbarimg`, available view `brew install zbar` [2].
#
# [1] https://superuser.com/questions/164892/
# [2] https://github.com/mchehab/zbar

set -ueo pipefail

function log { echo "$@" 1>&2; }
function die { log "$@"; exit 1; }

TEMP_IMG_FORMAT="png"
TEMP_IMG_FILE=$(mktemp -t screencapture) || die "Failed to create temporary file"

function cleanup {
    log "Removing $TEMP_IMG_FORMAT screenshot file '$TEMP_IMG_FILE'"
    rm -f "$TEMP_IMG_FILE"
}

trap cleanup EXIT
trap cleanup SIGINT

TARGET="$TEMP_IMG_FORMAT screenshot file '$TEMP_IMG_FILE'"

log "Writing $TARGET"
screencapture -x -t "$TEMP_IMG_FORMAT" "$TEMP_IMG_FILE" \
    || die "Failed to capture screen"
log "Wrote $TARGET"

log "Looking for QR codes in $TARGET"
{
    zbarimg -q "$TEMP_IMG_FILE" 2>/dev/null ||
        case "$?" in
            4) log "No QR codes found in $TARGET" ;;
            *) die "Failed to read QR code from screen capture" ;;
        esac
} | perl -n -e 's/^QR-Code:// && print'
