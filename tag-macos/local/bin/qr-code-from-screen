#!/usr/bin/env bash

set -ueo pipefail

function log { :; }
function die { echo "$@" >&2; exit 1; }

CAPTURE_ARGS=""
TEMP_IMG_FORMAT="png"
TEMP_IMG_FILE=$(mktemp -t screencapture) || die "Failed to create temporary file"
TARGET="$TEMP_IMG_FORMAT screenshot file '$TEMP_IMG_FILE'"

function cleanup {
    log "Removing $TARGET"
    rm -f "$TEMP_IMG_FILE"
}

while [[ "$#" -gt 0 ]]; do
    case "$1" in
        -h|--help)
            cat <<'EOF'

Attempts to write to stdout the value of the first QR code found on the screen.

Options:

  -h, --help
    Prints this message.

  -v, --verbose
    Print log lines to stderr.

  -i, --interactive
    Triggers interactive screen capture, allowing some portion of the screen to be captured instead of the whole screen.

  -k, --keep-screenshot
    Do not remove the temporary file containing the screenshot on exit.

Dependencies:

  `screencapture`, a macos utility [1].

  `zbarimg`, available view `brew install zbar` [2].

[1] https://superuser.com/questions/164892/
[2] https://github.com/mchehab/zbar

EOF
            exit
            ;;
        -v|--verbose)
            shift
            function log { echo "$@" >&2; }
            ;;
        -i|--interactive)
            shift
            CAPTURE_ARGS="-i"
            ;;
        -k|--keep-screenshot)
            shift
            function cleanup { :; }
            ;;
        *)
            die "Unknown option '$1'"
            ;;
    esac
done

trap cleanup EXIT
trap cleanup SIGINT

log "Writing $TARGET"
screencapture $CAPTURE_ARGS -x -t "$TEMP_IMG_FORMAT" "$TEMP_IMG_FILE" \
    || die "Failed to capture screen"
log "Wrote $TARGET"

log "Looking for QR codes in $TARGET"
{
    zbarimg -q "$TEMP_IMG_FILE" 2>/dev/null ||
        case "$?" in
            4) log "No QR codes found in $TARGET" ;;
            *) die "Failed to read QR code from screen capture" ;;
        esac
} | perl -n -e 's/^QR-Code:// && print'
